{% extends 'base_fullscreen.html' %}
{% block title %}{{dataset}} | Temporal squares {% endblock %}
{% block style %}
	<style type="text/css">
		body {
			background-color: black;
			color: white;
		}		

		a {
			color: white;
			visited: white; 
		}
	</style>
{% endblock %}

{% block content %}
	<div id="picture"></div>
	
	<hr>
		
	<div>
		<h3 id="label1"></h2>  
		<p id="label2"> </p>  				
	</div>
	
	<div id="docs_links">
	</div>
{% endblock %}

{% block javascript %} 
<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>

<script type="text/javascript">
	
	{% autoescape off %}
	{{data}}
	{% endautoescape %}
	
	var api = new ArtmApi(); 
	var topics_count = topics.length; 
	var dates_count = dates.length; 
	
	var topic_label_width = 200;
	var square_size = 18;
	
	//Width and height
	var w = 1200;
	var h = square_size * topics_count + 50;
	
	
	cells_content = [];
	
	//Create SVG element
	var svg = d3.select("#picture")
				.append("svg")
				.attr("width", w)
				.attr("height", h);
				
	var group_cells = svg.append("g");
	var group_topic_labels = svg.append("g");
	var group_date_labels = svg.append("g");
	var group_colorbar = svg.append("g");
	
	 
	var selected_cell; 
	
	var cells = group_cells.selectAll("rect")
		.data(cells)
		.enter()
		.append("rect")
		.attr("x", function(d, i) {
				return topic_label_width+square_size*d["X"];
		})
		.attr("y", function(d, i) {
			return square_size*d["Y"] + 1;
		})
		.attr("width", square_size - 2)
		.attr("height", square_size - 2)				
		.attr("fill", function(d, i) {
			return get_color(d["intense"]);
		})
		.on("mouseover", function(d, i) {
			d3.select(this) 
				.attr("stroke", "white")
				.attr("stroke-width", 3); 
		})
		.on("mouseout", function(d, i) { 
			if (this != selected_cell) {
				d3.select(this) 
					.attr("stroke-width", 0);
			}
		})
		.on("click", function(d, i) {
			d3.select(selected_cell) 
				.attr("stroke-width", 0);
			d3.select(this) 
				.attr("stroke", "red")
				.attr("stroke-width", 3);
			selected_cell = this;
			document.getElementById("label1").innerHTML = "Тема " + topics[d["Y"]].name + ", " + dates[d["X"]]["name"];
			document.getElementById("label2").innerHTML = "Всего документов: " + d["intense"];
			
			/*
			if (docs_links) {
				docs_links
					.exit()
					.remove();
			}*/
			
			d3.select("#docs_links").selectAll("p")
				.remove();
			
			
			
			api.getDocuments(d["docs"], function(documents) {
				var docs_links = d3.select("#docs_links").selectAll("p")
					.data(documents)
					.enter()
					.append("p") 
					.html(function(doc, i) {
						return "<a href='/visual/document?id=" + doc["id"] + "'>" + doc["title"] + "</a> (" + doc["time"] + ")";
					})
			}); 					
		});
		
		
	var date_labels = group_date_labels.selectAll("text")
		.data(dates)
		.enter()
		.append("text")
		.text(function(d,i) {
			if (i%2 == 0) {
			   return d["name"];
			}  
		})
		.attr("fill", "white")
		.attr("text-anchor", "end")
		.attr("transform", function(d, i) {
			var X = topic_label_width + 14 + square_size*d["X"];
			var Y = 2 + square_size * topics_count;
			return "translate (" + X + "," + Y + ") rotate(-90)"
		});
		
	var topic_labels = group_topic_labels.selectAll('text')
		.data(topics) 	 
		.enter()
		.append('text')
		.attr("x", topic_label_width - 3)
		.attr("y", function(d) {
			return 13+square_size*d["Y"];
		})
		.text(function(d, i) {
			return d["name"];
		})
		.attr("fill", "white")
		.attr("text-anchor", "end");
	 
	
	/*
	//COLORBAR-----------
	var color_space = [];
	var colorbar_top = 100;
	var colorbar_bottom = 300;
	var step_height = (colorbar_bottom - colorbar_top)/(max_intense+1)+1;
	var label_step = (max_intense / 10)>> 0;
	
	
	for (i=0; i<=max_intense; ++i) {
		color_space.push({"intense":i, "color":get_color(i)});
	}
	
	var colorbar_items = group_colorbar.selectAll("rect")
		.data(color_space)
		.enter()
		.append("rect")
		.attr("x", function(d, i) {
				return topic_label_width + square_size * dates_count ;
		})
		.attr("y", function(d, i) {
			return colorbar_top + (colorbar_bottom - colorbar_top) * (d["intense"] / max_intense);
		})
		.attr("width", 5)
		.attr("height", step_height)				
		.attr("fill", function(d, i) {
			return d["color"];
		});
		
	var colorbar_labels = group_colorbar.selectAll("text")
		.data(color_space)
		.enter()
		.append("text")
		.attr("x", function(d, i) {
				return topic_label_width + square_size * dates_count + 8 ;
		})
		.attr("y", function(d, i) {
			return colorbar_top + (colorbar_bottom - colorbar_top) * (d["intense"] / max_intense) + step_height;
		})
		.text(function(d, i) {
			if (i % label_step == 0) {
			   return d["intense"];
			}  
		})				
		.attr("fill", "white");
		
	//COLORBAR---------
	 
	var monthes = ["Январь", "Февраль", "Март", "Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
	function getDate(d) {
		return monthes[parseInt(d["month"])-1] + " " + d["year"];
	}
	*/
	function get_color(intense) {
		k = intense / max_intense;
		return d3.rgb(255*k, 206*k, 142*k);
	} 
	

</script>
{% endblock %}